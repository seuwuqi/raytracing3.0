<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">

    <title>threejs-basic-geometry</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        .my_output_bottom_left {
            background-color: #c3c3c3;
            bottom: 0px;
        }
    </style>
</head>


<!--图层 three.js/example/layers-->
<body>

    <!--导航-->
    <header id = "navigate" class="navbar fixed-top navbar-expand-sm navbar-light bg-light" style="background-color: #e3f2fd;">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link btn-light" href="javascript:;" onclick="sendMessage('2')">开始程序</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle btn-light" data-toggle="dropdown" href="#" role="button" aria-haspopup="true"
                                         aria-expanded="false">设置场景</a>
                <div class="dropdown-menu">
                    <button class="dropdown-item" data-toggle="modal" data-target="#exampleModalCenter">打开地图文件</button>
                    <button class="dropdown-item" data-toggle="modal" data-target="#roadfile">打开道路文件</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" data-toggle="modal" data-target="#sceneChoice">选择默认场景</button>
                    <a class="dropdown-item" href="javascript:;" onclick="parseFile()">默认地图</a>
                    <a class="dropdown-item" href="javascript:;" onclick="parseDefaultfile('seu')">东南大学</a>
                    <a class="dropdown-item" href="javascript:;" onclick="parseDefaultfile('nhdx')">内环东线</a>
                    <a class="dropdown-item" href="javascript:;" onclick="parseDefaultfile('zsl')">中山路</a>
                    <a class="dropdown-item" href="javascript:;" onclick="location.reload()">重置场景</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle btn-light" data-toggle="dropdown" href="#" role="button" aria-haspopup="true"
                   aria-expanded="false">设置车辆</a>
                <div class="dropdown-menu">
                    <button class="dropdown-item" data-toggle="modal" data-target="#vehicleModal">添加车辆</button>
                    <a class="dropdown-item" href="javascript:;"  onclick="setTx('tx')">添加Tx</a>
                    <a class="dropdown-item" href="javascript:;"  onclick="setTx('rx')">添加Rx</a>
                    <a class="dropdown-item" href="javascript:;"  onclick="setTx('other')">添加车辆</a>
                    <a class="dropdown-item" href="javascript:;"  onclick="reset()">重置</a>
                    <div class="dropdown-divider"></div>
                </div>
            </li>
            <li class="nav-item">
                <a class="btn btn-light" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false"
                    aria-controls="collapseExample">
                    图层信息
                </a>
                <a class="btn btn-light" data-toggle="collapse" href="#collapseExample01" role="button" aria-expanded="false"
                    aria-controls="collapseExample01">
                    输出结果
                </a>

            </li>


        </ul>



    </header>


    <!--显示界面-->

            <div id="webgl" class="card card-success w-100 h-100" style="height:800px"></div>
            <div id="gui" class="position-absolute" width="100" style="top: 60px;left: 0px;color: white;">
            </div>
            <div class="collapse position-absolute" id="collapseExample" style="bottom:0px">
                <div class="card card-body">
                    <div style="height: 400px" class="card card-success">
                        <table class="table table-hover">
                            <thead>
                                <tr class="active">
                                    <th>Car ID</th>
                                    <th>RX</th>
                                    <th>Coordinate</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="table-success">
                                    <td><button type="button" class="btn btn-success btn-sm" data-toggle="tooltip"
                                            data-placement="bottom" title="点击可以更新车辆状态">
                                            001
                                        </button></td>
                                    <td>True</td>
                                    <td>(13.5,6.2)</td>
                                    <td>A</td>
                                </tr>
                                <tr class="table-danger">
                                    <td><button type="button" class="btn btn-danger btn-sm" data-toggle="tooltip"
                                            data-placement="bottom" title="点击可以更新车辆状态">
                                            002
                                        </button></td>
                                    <td>False</td>
                                    <td>(14.5,7.5)</td>
                                    <td>A</td>
                                </tr>
                                <tr class="table-danger">
                                    <td><button type="button" class="btn btn-danger btn-sm" data-toggle="tooltip"
                                            data-placement="bottom" title="点击可以更新车辆状态">
                                            003
                                        </button></td>
                                    <td>False</td>
                                    <td>(17.7,5.2)</td>
                                    <td>A</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="collapse position-absolute" id="collapseExample01"  style="bottom:0px;right: 0px;z-index: 5" >
                <div class="card card-body">
                    <!--数据展示部分 container-->
                    <div class="container">
                        <div class="card card-success">
                            <div class="btn-group btn-group-sm">
                                <button id="pathloss" type="button" class="btn btn-primary">路径损耗</button>
                                <button id="powerdelay" type="button" class="btn btn-secondary">功率时延分布</button>
                                <button id="meandelay" type="button" class="btn btn-success">平均附加时延</button>
                                <button id="dimpowerdelay" type="button" class="btn btn-danger">功率时延空间分布</button>
                            </div>
                            <div id="main" style="width:600px;height:400px"></div>
                        </div>
                    </div>
                </div>
            </div>
            <canvas id="locationCanvas" class="position-absolute" width="200" height="40" style="border:1px solid #c3c3c3;top: 70px;right: 20px;color: white;">
                Your browser does not support the canvas element.
            </canvas>




    <!--模态框 车辆设置-->
    <div class="modal fade" id="vehicleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" >新建车辆</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form >
                        <div class="form-group row">
                            <label for="speed" class="col-sm-2 col-form-label">车速</label>
                            <div class="col-sm-10">
                                <input type="number" id="speed" name="tentacles"
                                       min="10" max="100">km/h
                            </div>

                        </div>
                        <fieldset class="form-group">
                            <div class="row">
                                <legend class="col-form-label col-sm-2 pt-0">类型</legend>
                                <div class="col-sm-10">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gridRadios" id="gridRadios1" value="tx" checked>
                                        <label class="form-check-label" for="gridRadios1">
                                            发射车辆
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gridRadios" id="gridRadios2" value="other">
                                        <label class="form-check-label" for="gridRadios2">
                                            障碍车辆
                                        </label>
                                    </div>
                                    <div class="form-check disabled">
                                        <input class="form-check-input" type="radio" name="gridRadios" id="gridRadios3" value="rx" >
                                        <label class="form-check-label" for="gridRadios3">
                                            接收车辆
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="form-group row">
                            <div class="col-sm-2">动态</div>
                            <div class="col-sm-10">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dynamic">
                                    <label class="form-check-label" for="dynamic">
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-10">
                                <button data-dismiss="modal" type="submit" class="btn btn-primary" onclick="processVehicleForm()">新建</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 模态框 场景选择-->
    <div class="modal"  id = "sceneChoice" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">场景选择</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <!--<button data-dismiss=""></button>-->
                </div>
                <div class="默认场景选择">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm">
                                <a data-dismiss="modal" href="javascript:;" onclick="parseDefaultfile('seu') ">
                                    <div  class="card" style="width: 8rem;">
                                        <img src = "./img/东南大学.jpg" style=" height: 6rem;" class="card-img-top"  alt="Card image cap">
                                        <div class="card-body">
                                            <p class="card-text">东南大学</p>
                                        </div>
                                    </div>
                                </a>

                            </div>
                            <div class="col-sm">
                                <a data-dismiss="modal" href="javascript:;" onclick="parseDefaultfile('zsl')">

                                    <div  class="card" style="width: 8rem ;">
                                        <img src = "./img/中山路.jpg" style=" height: 6rem;" class="card-img-top"  alt="Card image cap">
                                        <div class="card-body">
                                            <p class="card-text">中山路</p>
                                        </div>
                                    </div>
                                </a>

                            </div>
                            <div class="col-sm">
                                <a  data-dismiss="modal" href="javascript:;" onclick="parseDefaultfile('nhdx')">
                                    <div  class="card" style="width: 8rem; ">
                                        <img src = "./img/内环东线.jpg" style=" height: 6rem;" class="card-img-top"  alt="Card image cap">
                                        <div class="card-body">
                                            <p class="card-text">内环东线</p>
                                        </div>
                                    </div>
                                </a>

                            </div>
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>




    <!-- Modal 模态框 文件选择-->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Open File</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <div class="custom-file">
                                <h5><span class="badge badge-secondary">shp文件:</span></h5>
                                <input type="file" class="form-control-file" id="file-input">
                                <hr>
                                <h5><span class="badge badge-secondary">dbf文件:</span></h5>
                                <input type="file" class="form-control-file" id="dbf-file-input">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="parseFile()" data-dismiss="modal">Open</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="roadfile" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roadfilelabel">Open File</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <div class="custom-file">
                                <h5><span class="badge badge-secondary">shp文件:</span></h5>
                                <input type="file" class="form-control-file" id="road-file-input">
                                <hr>
                                <h5><span class="badge badge-secondary">dbf文件:</span></h5>
                                <input type="file" class="form-control-file" id="road-dbf-file-input">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="parseRoadFile()" data-dismiss="modal">Open</button>
                </div>
            </div>
        </div>
    </div>



    <!--导入js-->
    <script type="text/javascript" src="js/three.js"></script>
    <script type="text/javascript" src="js/echarts.min.js"></script>
    <script type="text/javascript" src="js/echarts-gl.min.js"></script>
    <script type="text/javascript" src="js/Detector.js"></script>
    <script type="text/javascript" src="js/OrbitControls.js"></script>
    <script type="text/javascript" src="js/TDSLoader.js"></script>
    <script type="text/javascript" src="js/tether.min.js"></script>
    <script src="js/controls/DragControls.js"></script>
    <script src="js/controls/TrackballControls.js"></script>
    <script src="js/Lut.js"></script>
    <script src="js/loaders/FBXLoader.js"></script>
    <script src="js/libs/inflate.min.js"></script>
    <script src='js/libs/dat.gui.min.js'></script>


    <!--line-->
    <script src='js/lines/LineSegmentsGeometry.js'></script>
    <script src='js/lines/LineGeometry.js'></script>
    <script src='js/lines/WireframeGeometry2.js'></script>
    <script src='js/lines/LineMaterial.js'></script>
    <script src='js/lines/LineSegments2.js'></script>
    <script src='js/lines/Line2.js'></script>
    <script src='js/lines/Wireframe.js'></script>
    <script src="js/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="js/bootstrap.min.js"></script>
    <!--websocket-->
    <script type="text/javascript">
        var sendCode;
        function debug(message) {
            console.log(message);
        }

        function sendMessage(msg) {
            if (websocket != null) {
                websocket.send(msg);
                console.log("string sent :", '"' + msg + '"');
            } else {
                //initWebSocket();
                websocket.send(msg);
                console.log("string sent :", '"' + msg + '"');
            }
            sendCode = msg;
            // stopWebSocket();
        }

        var wsUri = "ws://localhost:1234";
        var websocket = null;
        initWebSocket();

        function initWebSocket() {
            try {
                if (typeof MozWebSocket == 'function')
                    WebSocket = MozWebSocket;
                if (websocket && websocket.readyState == 1)
                    websocket.close();
                websocket = new WebSocket(wsUri);
                websocket.onopen = function (evt) {
                    // sendMessage("1");
                    debug("CONNECTED");
                };
                websocket.onclose = function (evt) {
                    debug("DISCONNECTED");
                };
                websocket.onmessage = function (evt) {
                    console.log("Message received :", evt.data);
                    var data = JSON.parse(evt.data);
                    console.log(data.type);
                    if(data.type == "output"){
                        drawPath(data);
                    }
                    // if (sendCode == "1") {
                    //     readFromDataToArray(evt.data);
                    //     sendMessage("cordinate");
                    // } else if (sendCode == "2") {
                    //     drawPath(evt.data);
                    // }else if(sendCode == "3"){
                    //     drawRoad(evt.data);
                    // }else if (sendCode == "cordinate"){
                    //     processCordinate(evt.data);
                    // }
                    //debug(evt.data);
                };
                websocket.onerror = function (evt) {
                    debug('ERROR: ' + evt.data);
                };
            } catch (exception) {
                debug('ERROR: ' + exception);
            }
        }

        function stopWebSocket() {
            if (websocket)
                websocket.close();
        }

        function checkSocket() {
            if (websocket != null) {
                var stateStr;
                switch (websocket.readyState) {
                    case 0: {
                        stateStr = "CONNECTING";
                        break;
                    }
                    case 1: {
                        stateStr = "OPEN";
                        break;
                    }
                    case 2: {
                        stateStr = "CLOSING";
                        break;
                    }
                    case 3: {
                        stateStr = "CLOSED";
                        break;
                    }
                    default: {
                        stateStr = "UNKNOW";
                        break;
                    }
                }
                debug("WebSocket state = " + websocket.readyState + " ( " + stateStr + " )");
            } else {
                debug("WebSocket is null");
            }
        }
    </script>

    <!--echart-->
    <script type="text/javascript">
        // 基于准备好的dom，初始化echarts实例
        var button1 = document.getElementById("pathloss");
        var button2 = document.getElementById("powerdelay");
        var button3 = document.getElementById("meandelay");
        var button4 = document.getElementById("dimpowerdelay");

        var myChart = echarts.init(document.getElementById("main"));
        button4.onclick = function (ev) {
            loadDimenPowerDelay();
        };
        button3.onclick = function (ev) {
            console.log("b3");
            loadbutton2();
        };



        function loadbutton2() {
            option = {
                title: {
                    text: '平均附加时延',
                    subtext: '附加时延'
                },
                tooltip: {},
                backgroundColor: '#fff',
                visualMap: {
                    show: false,
                    dimension: 2,
                    min: -1,
                    max: 1,
                    inRange: {
                        color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
                    }
                },
                xAxis3D: {
                    type: 'value'
                },
                yAxis3D: {
                    type: 'value'
                },
                zAxis3D: {
                    type: 'value'
                },
                grid3D: {
                    viewControl: {
                        // projection: 'orthographic'
                    }
                },
                series: [{
                    type: 'surface',
                    wireframe: {
                        // show: false
                    },
                    equation: {
                        x: {
                            step: 0.05
                        },
                        y: {
                            step: 0.05
                        },
                        z: function (x, y) {
                            if (Math.abs(x) < 0.1 && Math.abs(y) < 0.1) {
                                return '-';
                            }
                            return Math.sin(x * Math.PI) * Math.sin(y * Math.PI);
                        }
                    }
                }]
            };
            myChart.setOption(option);
        }


        function loadDimenPowerDelay() {
            myChart.setOption({
                title: {
                    text: '功率时延空间分布',
                    subtext: '功率时延空间分布'
                },
                grid3D: {},
                xAxis3D: {},
                yAxis3D: {},
                zAxis3D: {},
                series: [{
                    type: 'scatter3D',
                    symbolSize: 1,
                    data: [
                        [-1, -1, -1],
                        [0, 0, 0],
                        [1, 1, 1]
                    ],
                    itemStyle: {
                        opacity: 1
                    }
                }]
            });
        }

        function loadPathLoss(pathLossOrder, pathLoss) {
            // 指定图表的配置项和数据
            option = {
                title: {
                    text: 'Ray-Tracing 路径损耗',
                    subtext: '路径损耗分布'
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['路径损耗']
                },
                toolbox: {
                    show: true,
                    feature: {
                        mark: {
                            show: true
                        },
                        dataView: {
                            show: true,
                            readOnly: false
                        },
                        magicType: {
                            show: true,
                            type: ['line', 'bar']
                        },
                        restore: {
                            show: true
                        },
                        saveAsImage: {
                            show: true
                        }
                    }
                },
                calculable: true,
                xAxis: [{
                    type: 'category',
                    data: pathLossOrder
                }],
                yAxis: [{
                    type: 'value'
                }],
                series: [{
                    name: '路径损耗/dB',
                    type: 'bar',
                    data: pathLoss,
                    markPoint: {
                        data: [{
                            type: 'max',
                            name: '最大值'
                        }, {
                            type: 'min',
                            name: '最小值'
                        }]
                    },
                    markLine: {
                        data: [{
                            type: 'average',
                            name: '平均值'
                        }]
                    }
                }]
            };
            // 使用刚指定的配置项和数据显示图表。
            myChart.setOption(option);
        }
    </script>

    <!--webgl-->
    <script type="text/javascript">
        //检测webgl的支持情况
        if (!Detector.webgl) {
            Detector.addGetWebGLMessage();
        }

        var container;
        var camera, scene, renderer;
        //用于轨道控制器
        var orbitControls, clock, delta;
        //loadXMLDoc();

        var mouse, raycaster, isShiftDown = false;
        var rollOverMesh, rollOverMaterial, rollOverGeo, rollOverLine;
        var cubeMesh;
        var objects = []; //存放平面，用于投影检测
        var builidings  = [];  //存放建筑物
        var tx = [], rx = [];
        var vehicles = [];
        var pathLines = [];
        var roadLines = [];
        var roadNames = [];
        var xmax , xmin , ymax , ymin ;
        var TxDTO;
        var RxDTO;
        var vehicleDTO;

        var lut;

        var layers = {
            plane : true,
            building: true,
            road : true,
            vehicles : true,
            ray : true,
        };
        main();

        render();
        loadPathLoss([1, 2, 3, 4, 5, 6], [-100, -101, -102, -103, -99, -98]);

        
        function processVehicleForm() {
            var speed = document.getElementById("speed").value;
            var type1 = document.getElementById("gridRadios1");
            var type2 = document.getElementById("gridRadios2");
            var type3 = document.getElementById("gridRadios3");
            var dynamic = document.getElementById("dynamic");
            var isDynamic = dynamic.checked;
            var type;
            if (type1.checked == true){
                type = "tx";
            } else if (type2.checked == true){
                type = "other";
            } else if(type3.checked == true){
                type = "rx";
            }
            console.log(speed);
            console.log(type);
            console.log(isDynamic);
            setVehicle(speed,type,isDynamic);
        }

        function setVehicle(speed,type,dynamic){
            var vehicle = {
                speed : speed,
                type : type,
                dynamic : dynamic
            }
            vehicles.push(vehicle);
            orbitControls.enabled = false;
            rollOverGeo = new THREE.BoxBufferGeometry(0.5, 0.5, 0.5);
            rollOverMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, opacity: 0.5, transparent: true });
            rollOverMesh = new THREE.Mesh(rollOverGeo, rollOverMaterial);


            var geometry = new THREE.LineGeometry();
            geometry.setPositions( [0,0,0,0,0,0] );
            // geometry.setColors( colors );
            var matLine = new THREE.LineMaterial( {
                color: "#222221",
                linewidth: 0.002,
                // vertexColors: THREE.VertexColors,
                dashed: true
            } );
            rollOverLine = new THREE.Line2( geometry, matLine );
            rollOverLine.computeLineDistances();
            rollOverLine.scale.set( 1, 1, 1 );
            scene.add( rollOverLine );

            scene.add(rollOverMesh);
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            vehicleType = type;
            dynamicMod = dynamic;
            count = 0;
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('mousedown', onDocumentMouseDown, false);

        }


        var vehicleType;
        var vehicleSpeed;
        var dynamicMod;
        var count;
        var startPoint;
        function onDocumentMouseMove(event) {
            event.preventDefault();
            mouse.set((event.clientX / window.innerWidth) * 2 - 1, - (event.clientY / window.innerHeight) * 2 + 1);
            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObjects(objects);
            var intersect;
            if (intersects.length > 0) {
                intersect = intersects[0];
                rollOverMesh.position.copy(intersect.point).add(intersect.face.normal);
                //rollOverMesh.position.divideScalar( 50 ).floor().multiplyScalar( 50 ).addScalar( 25 );
            }
            var canvas = document.getElementById("locationCanvas");
            var cxt = canvas.getContext("2d");
            cxt.font = "15px Arial";
            cxt.clearRect(0, 0, 200, 40);
            var x = intersect.point.z;
            var y = intersect.point.x;
            var longitude = x / 80 * (xmax - xmin) + (xmax + xmin) / 2;
            var latitude = y / 80 * (xmax - xmin) + (ymax + ymin) / 2;

            cxt.fillText(longitude, 10, 18);
            cxt.fillText(latitude, 10, 33);

            if(startPoint != undefined){
                var positions = [];
                positions.push(y,0.1,x);
                positions.push(startPoint.y,0.1,startPoint.x);
                rollOverLine.geometry.setPositions(positions);
            }
            //render();
        }
        //设置TX
        function onDocumentMouseDown(event) {
            event.preventDefault();
            mouse.set((event.clientX / window.innerWidth) * 2 - 1, - (event.clientY / window.innerHeight) * 2 + 1);
            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObjects(objects);
            if (intersects.length > 0) {
                var intersect = intersects[0];
                count  += 1;
                if(count == 2){//动态模式

                    var triangleShape = new THREE.Shape();
                    triangleShape.moveTo( 0, 0 );
                    triangleShape.lineTo( 0.5, 1 );
                    triangleShape.lineTo( 1, 0.5);
                    triangleShape.lineTo( 0, 0 ); // close path
                    var geometry = new THREE.ShapeBufferGeometry( triangleShape );
                    var mesh = new THREE.Mesh( geometry, new THREE.MeshPhongMaterial( {side: THREE.DoubleSide, color : "#000000"} ) );

                    console.log(intersect.point.x);
                    console.log(startPoint.y);
                    console.log(intersect.point.z);
                    console.log(startPoint.x);
                    var angle = Math.atan((intersect.point.x - startPoint.y)
                        / (intersect.point.z - startPoint.x));
                    if(intersect.point.z - startPoint.x < 0){
                        angle += Math.PI;
                    }
                    console.log(angle);
                    mesh.position.copy(intersect.point);
                    mesh.position.y = 0.1;
                    mesh.rotation.set( Math.PI / 2, 0, Math.PI * 5 / 4 );
                    mesh.rotateZ(2 * Math.PI - angle);
                    mesh.scale.set( 2, 2, 2 );
                    scene.add(mesh);

                }else{
                    if (vehicleType == "other"){
                        loadFbx(intersect,vehicleType)
                    } else {
                        load3DS(intersect, vehicleType);
                    }
                }

                scene.remove(rollOverMesh);
                var x = intersect.point.z;
                var y =  intersect.point.x;
                var longitude = x/80*(xmax - xmin) + (xmax + xmin) / 2;
                var latitude  = y/80*(xmax - xmin) + (ymax + ymin)  / 2;
                vehicleDTO = { "speed" : vehicleSpeed, "type" : vehicleType,"longitude" : longitude , "latitude" : latitude};

                var str = JSON.stringify(vehicleDTO);
                sendMessage(str);

            }
            if (dynamicMod == undefined || dynamicMod == false || count == 2){
                count = 0;
                startPoint = undefined;
                orbitControls.enabled = true;
                dynamicMod = false;
                document.removeEventListener('mousemove', onDocumentMouseMove, false);
                document.removeEventListener('mousedown', onDocumentMouseDown, false);
            }else{
                startPoint = {x : x, y : y};
            }
        }
        function drawSenario(senario,mod) {

            var pointX = [];
            var pointY = [];
            var pointZ = [];
            for (var i = 0; i < senario.features.length; i++){
                var pointXX = [];
                var pointYY = [];
                var coords = senario.features[i].coordinates;
                for (var j = 0; j < coords.length; j ++) {
                    var x = coords[j][0];
                    var y = coords[j][1];
                    pointXX.push(  (x - (xmax + xmin)/ 2)/(xmax - xmin) * 80 );
                    pointYY.push(  (y - (ymax + ymin)/ 2)/(xmax - xmin) * 80 );
                    // pointXX.push(  (x - xmin)/(xmax - xmin) * 80 );
                    // pointYY.push(  (y - ymin)/(xmax - xmin) * 80 );
                }
                pointX.push(pointXX);
                pointY.push(pointYY);
                pointZ.push(  (senario.features[i].z) / 80 *  (118.813658- 118.728997)/( xmax - xmin));

            }
            layers.building = true;
            camera.layers.enable( 1 );
            builidings = [];
            for (var i = 0; i < pointX.length; i++) {
                addMulGeometry(pointX[i], pointY[i], pointZ[i],mod);
            }

            gui.add( layers, 'building' ).onChange( function () {
                camera.layers.toggle( 1 );
            } );
        }
        function setTx(type) {
            orbitControls.enabled = false;
            // roll-over helpers
            rollOverGeo = new THREE.BoxBufferGeometry(0.5, 0.5, 0.5);
            rollOverMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, opacity: 0.5, transparent: true });
            rollOverMesh = new THREE.Mesh(rollOverGeo, rollOverMaterial);
            scene.add(rollOverMesh);
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            vehicleType = type;
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('mousedown', onDocumentMouseDown, false);
        }
        function hide( objs) {
            for (let i = 0; i < objs.length; i++) {
                scene.remove(scene.getObjectByName(objs[i].name));
            }
        }
        function remove(objs) {
            hide(objs);
            var len = objs.length;
            objs = [];
        }
        function resume(objs) {
            if (objs.size == 0){
                return;
            }
            for (let i = 0; i < objs.length; i++) {
                scene.add(objs[i]);
            }
        }
        function reset() {
            remove(tx);
            remove(rx);
            remove(pathLines);
            container2.parentNode.removeChild(container2);
        }

        function setRx() {

            orbitControls.enabled = false;
            // roll-over helpers
            rollOverGeo = new THREE.BoxBufferGeometry(1, 0.5, 0.7);
            rollOverMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, opacity: 0.5, transparent: true });
            rollOverMesh = new THREE.Mesh(rollOverGeo, rollOverMaterial);
            scene.add(rollOverMesh);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('mousedown', onDocumentMouseDown2, false);

        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function processCordinate(result) {
            var obj = JSON.parse(result);
            xmax = obj.xmax;
            xmin = obj.xmin;
            ymax = obj.ymax;
            ymin = obj.ymin;
        }
        function drawRoad(roads){
            var roadName = "init";
            roadLines = [];
            for (let i = 0; i < roads.length; i++){
                var geometry = new THREE.Geometry();
                var material = new THREE.LineBasicMaterial( { vertexColors: true } );
                var color1 = new THREE.Color( "#FFFFFF" );
                var color2 = new THREE.Color( "#FFFFFF");
                var coordinates = roads[i].coordinates;
                var name = roads[i].name;
                var direction = roads[i].direction;
                var mid = Math.floor(coordinates.length / 2);
                var pm = coordinates[0];
                // console.log(mid);
                var x = pm[0];
                var y = pm[1];
                x = (x- (xmax + xmin)/ 2)/(xmax - xmin) * 80;
                y = (y- (ymax + ymin)/ 2)/(xmax - xmin) * 80;
                // console.log(x);
                // console.log(y);
                for(let j = 0; j < coordinates.length - 1; j++){
                    var p1 = coordinates[j], p2 = coordinates[j+1];
                    var x1 = (p1[0] - (xmax + xmin)/ 2)/(xmax - xmin) * 80;
                    var y1 = (p1[1] - (ymax + ymin)/ 2)/(xmax - xmin) * 80;
                    var x2 = (p2[0] - (xmax + xmin)/ 2)/(xmax - xmin) * 80;
                    var y2 = (p2[1] - (ymax + ymin)/ 2)/(xmax - xmin) * 80;
                    var q1 = new THREE.Vector3(y1, 0, x1);
                    var q2 = new THREE.Vector3(y2, 0, x2);
                    geometry.vertices.push(q1);
                    geometry.vertices.push(q2);
                    geometry.colors.push( color1, color2 );
                    var line = new THREE.Line( geometry, material, THREE.LineSegments );
                    line.layers.set( 2 );
                    line.name = Math.random().toString(36).substr(2);
                    scene.add(line);
                    roadLines.push(line);
                }
                if(name != roadName){
                    // drawFont(name,x,y,direction);
                    roadName = name;
                }
            }
            camera.layers.enable( 2 );
            gui.add( layers, 'road' ).onChange( function () {
                camera.layers.toggle( 2 );
            } );

            // gui.remove();

        }


        function loadLegends(colorMap, numberOfColors, legendLayout){

            lut = new THREE.Lut( colorMap, numberOfColors );

            lut.setMax( 2000 );
            lut.setMin( 1000 );

            if ( legendLayout ) {

                var legend;

                if ( legendLayout === 'horizontal' ) {

                    legend = lut.setLegendOn( { 'layout':'horizontal', 'position': { 'x': 0, 'y': -3, 'z': 3} } );

                } else {

                    legend = lut.setLegendOn();

                }

                scene.add ( legend );

                var labels = lut.setLegendLabels( { 'title': 'PathLoss', 'um': 'dB', 'ticks': 5 } );

                scene.add ( labels['title'] );

                for ( var i = 0; i < Object.keys( labels[ 'ticks' ] ).length; i ++ ) {

                    scene.add ( labels[ 'ticks' ][ i ] );
                    scene.add ( labels[ 'lines' ][ i ] );

                }

            }
        }
        function drawPath(data) {
            initColorMap(-200,-70);
            var paths = data.paths;
            for (var p in paths) {
                var path = paths[p];
                var nodeList = path.nodeList;
                var geometry = new THREE.Geometry();
                var material = new THREE.LineBasicMaterial({ vertexColors: true });
                var color1 = new THREE.Color(0x444444), color2 = new THREE.Color(0xFF0000);
                var color = lut.getColor( path.pathloss );
                console.log(color);
                for (let i = 0; i < nodeList.length; i++) {
                    nodeList[i].x = (nodeList[i].x - (xmax + xmin) / 2)/(xmax - xmin) *80;
                    nodeList[i].y = (nodeList[i].y - (ymax + ymin)/ 2)/(xmax - xmin) * 80;
                }
                for (let i = 0; i < nodeList.length - 1; i++) {
                    var p1 = new THREE.Vector3(nodeList[i].y, 0.5, nodeList[i].x);
                    var p2 = new THREE.Vector3(nodeList[i + 1].y, 0.5, nodeList[i + 1].x);
                    geometry.vertices.push(p1);
                    geometry.vertices.push(p2);
                    geometry.colors.push(color,color);
                    var line = new THREE.Line(geometry, material, THREE.LineSegments);
                    line.name = Math.random().toString(36).substr(2);
                    scene.add(line);
                    line.layers.set(4);
                    pathLines.push(line);
                }
            }
            camera.layers.enable( 4 );
            gui.add( layers, 'ray' ).onChange( function () {
                camera.layers.toggle( 4 );
            } );

        }
        function readFromDataToArray(result) {

            var obj = JSON.parse(result);
            console.log(obj[0][0].x)
            console.log(obj[0][0].y)
            //console.log(obj.length)
            var pointX = [];
            var pointY = [];
            var pointZ = [];

            for (var p in obj) {
                var data = obj[p];
                var pointXX = [];
                var pointYY = [];
                for (var i = 0; i < data.length; i++) {
                    pointXX.push(data[i].x);
                    pointYY.push(data[i].y);
                }

                pointX.push(pointXX);
                pointY.push(pointYY);
                pointZ.push(data[0].z);
            }
            // for (var i = 0; i < 261; i++) {
            //     var pointXX = [];
            //     var pointYY = [];
            //     for (var j = obj[i].length - 1; j >= 0; j--) {
            //         pointXX.push(obj[i][j].x);
            //         pointYY.push(obj[i][j].y);
            //     }
            //
            //     pointX.push(pointXX);
            //     pointY.push(pointYY);
            //     pointZ.push(obj[i][0].z);
            // }
            for (var i = 0; i < pointX.length; i++) {
                addMulGeometry(pointX[i], pointY[i], pointZ[i]);
            }
        }

        function loadPathLossGet() {
            var xmlhttp;
            if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp = new XMLHttpRequest();
            } else { // code for IE6, IE5
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    var result = xmlhttp.responseText;
                    console.log(result);
                    //document.getElementById("myDiv").innerHTML=result;
                    var obj = JSON.parse(result);
                    console.log(obj.length);
                    var pathLossT = [];
                    var pathLossOrder = [];
                    for (var i = 0; i < obj.length; i++) {
                        pathLossT.push(obj[i]);
                        pathLossOrder.push(i);
                    }
                    //loadDimenPowerDelay();
                    loadPathLoss(pathLossOrder, pathLossT);
                }
            }
            xmlhttp.open("GET", "http://localhost:8080/user/getPathLoss.html", true);
            xmlhttp.send();
        }

        //主函数
        function loadXMLDoc() {
            var xmlhttp;
            if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp = new XMLHttpRequest();
            } else { // code for IE6, IE5
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    var result = xmlhttp.responseText;
                    //document.getElementById("myDiv").innerHTML=result;
                    var obj = JSON.parse(result);
                    console.log(obj[0][0].x)
                    console.log(obj[0][0].y)
                    //console.log(obj.length)
                    var pointX = [];
                    var pointY = [];
                    var pointZ = [];
                    for (var i = 0; i < 261; i++) {
                        var pointXX = [];
                        var pointYY = [];
                        for (var j = obj[i].length - 1; j >= 0; j--) {
                            pointXX.push(obj[i][j].x);
                            pointYY.push(obj[i][j].y);
                        }
                        pointX.push(pointXX);
                        pointY.push(pointYY);
                        pointZ.push(obj[i][0].z);
                    }
                    main(pointX, pointY, pointZ);
                    render();
                    loadPathLossGet();

                    //alert(obj[0].length);
                }
            }
            xmlhttp.open("GET", "http://localhost:8080/user/hello.html", true);
            xmlhttp.send();
        }

        // model
        function loadFbx(intersect, type){
            var fbxloader = new THREE.FBXLoader();
            fbxloader.load( 'bus/bus.fbx', function ( object ) {

                object.traverse( function ( child ) {
                    if ( child.isMesh ) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                } );
                object.scale.set(0.0004, 0.0004, 0.0004);
                object.position.copy(intersect.point);
                object.position.y = 0.6;
                // object.rotateX(Math.PI * 6 / 4);
                object.rotateY(camera.rotation._z);
                object.rotateY(Math.PI);
                object.name = Math.random().toString(36).substr(2);
                scene.add( object );
                if (type == "tx") {
                    tx.push(object);
                } else if (type == "rx") {
                    rx.push(object);
                }
            } );

        }

        function load3DS(intersect, type) {
            var loader = new THREE.TDSLoader();
            loader.load("./Evo.3ds", function (object) {
                object.traverse(function (child) {
                    if (child instanceof THREE.Mesh) {
                        child.material.side = THREE.DoubleSide;
                        //child.material.normalMap = normal;
                    }
                });
                object.scale.set(0.002, 0.002, 0.002);
                object.position.copy(intersect.point);
                object.rotateX(Math.PI * 6 / 4);
                object.rotateZ(camera.rotation._z);
                // object.rotateZ(camera.rotation._z);
                object.rotateZ(Math.PI);
                object.name = Math.random().toString(36).substr(2);
                // object.layers.set(3);
                // camera.layers.enable( 3 );
                scene.add(object);
                if (type == "tx") {
                    tx.push(object);
                } else if (type == "rx") {
                    rx.push(object);
                }

            });
        }

        var container2;
        var scene2;
        var lut;
        var renderer2;
        var camera2;

        var gui;
        function initColorMap(min, max){
            container2 = document.createElement('colorMap');
            document.body.appendChild(container2);
            var width = 120;
            var height = 300;
            scene2 = new THREE.Scene(); //创建一个新场景
            //添加一个透视相机
            // CAMERA
            camera2 = new THREE.PerspectiveCamera( 16,width /height, 1, 100 );
            camera2.position.set( 0, 0,  10);
            //渲染
            //antialias:true增加抗锯齿效果
            renderer2 = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            var colorMap = 'rainbow';
            var numberOfColors = 512;
            lut = new THREE.Lut( colorMap, numberOfColors );
            lut.setMax( max );
            lut.setMin( min );
            var legend = lut.setLegendOn( { 'position': { 'x': -0.3, 'y': -0.1, 'z': -5 }} );
            var labels = lut.setLegendLabels( { 'title': 'PathLoss', 'um': 'dB', 'ticks': 5 } );
            // renderer2.setClearColor(new THREE.Color(0xffffff)); //设置窗口背景颜色为黑
            renderer2.setClearAlpha(0);
            renderer2.setSize(width, height); //设置窗口尺寸
            //将renderer关联到container，这个过程类似于获取canvas元素
            container2.appendChild(renderer2.domElement);
            container2.style.position = "absolute";
            container2.style.bottom = "100px";
            container2.style.right = "30px";
            scene2.add( legend );
            scene2.add( labels[ 'title' ] );
            for ( var i = 0; i < Object.keys( labels[ 'ticks' ] ).length; i ++ ) {
                scene2.add( labels[ 'ticks' ][ i ] );
                scene2.add( labels[ 'lines' ][ i ] );
            }
            renderer2.render(scene2, camera2);
        }

        // render2();
        function main() {
            //添加一个div元素
            container = document.getElementById('webgl');
            //document.body.appendChild(container);
            var width = window.innerWidth;
            var height = window.innerHeight;
            scene = new THREE.Scene(); //创建一个新场景
            //添加一个透视相机
            camera = new THREE.PerspectiveCamera(30,
                width / height, 1, 1000);
            camera.position.set(-100, 300, -100); //设置相机位置
            camera.lookAt(new THREE.Vector3(0, 0, 0)); //让相机指向原点
            //渲染
            //antialias:true增加抗锯齿效果
            renderer = new THREE.WebGLRenderer({
                antialias: true
            });
            renderer.setClearColor(new THREE.Color(0xffffff)); //设置窗口背景颜色为黑
            renderer.setSize(width, height); //设置窗口尺寸
            //将renderer关联到container，这个过程类似于获取canvas元素
            container.appendChild(renderer.domElement);

            //添加轨道控制器
            // 新建一个轨道控制器
            orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
            orbitControls.target = new THREE.Vector3(0, 0, 0); //控制焦点
            orbitControls.autoRotate = false; //将自动旋转关闭
            clock = new THREE.Clock(); //用于更新轨道控制器
            //给场景添加光源
            //自然光
            var ambientLight = new THREE.AmbientLight(0x606060);
            scene.add(ambientLight);
            //平行光源
            var directionalLight = new THREE.DirectionalLight(0xffffff);
            directionalLight.position.set(1, 0.75, 0.5).normalize();
            scene.add(directionalLight);

            var nav = document.getElementById("gui");
            gui = new dat.GUI();
            var guiDomElement = gui.domElement;
             // guiDomElement.style.position = "relative";
            // guiDomElement.style.top = "0px";
            // guiDomElement.style.right = "10px";
            // guiDomElement.style.zIndex = "20";
            nav.appendChild(guiDomElement);
            // container.appendChild(guiDomElement);

             plane();

            // var gridHelper = new THREE.GridHelper( 80, 30 );
            // scene.add( gridHelper );
            window.addEventListener('resize', onWindowResize, false);
            // dragControlInit();
            //  var gridHelper = new THREE.GridHelper( 50, 100 );
            //  scene.add( gridHelper );
        }


        function plane() {
            var geometry = new THREE.PlaneBufferGeometry(120, 120);
            geometry.rotateX(- Math.PI/2 );
            var plane = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({ color: "#88918c", visible: true }));
            plane.layers.set(0);
            gui.add( layers, 'plane' ).onChange( function () {
                camera.layers.toggle( 0 );
            } );
            scene.add(plane);
            objects.push(plane);
        }

        //创建一个立方体
        function cube() {
            //THREE.CubeGeometry(width,height,depth,widthSegments,heightSegments, depthSegments)
            var cubeGeo = new THREE.CubeGeometry(20, 20, 10, 15, 5, 5); //创建立方体
            var cubeMat = new THREE.MeshLambertMaterial({ //创建材料
                color: 0x003300,
                wireframe: false
            });
            cubeMesh = new THREE.Mesh(cubeGeo, cubeMat); //创建立方体网格模型
            cubeMesh.position.set(20, 10, 0); //设置立方体的坐标 几何中心
            scene.add(cubeMesh); //将立方体添加到场景中
        }
        //创建一个球
        function sphere() {
            var sphereGeo = new THREE.SphereGeometry(16, 40, 40); //创建球体
            var sphereMat = new THREE.MeshLambertMaterial({ //创建材料
                color: 0x0000FF,
                wireframe: false
            });
            var sphereMesh = new THREE.Mesh(sphereGeo, sphereMat); //创建球体网格模型
            sphereMesh.position.set(-25, 16, 0); //设置球的坐标
            scene.add(sphereMesh); //将球体添加到场景
        }

        //创建圆柱体
        function cylinder() {
            //创建圆柱体
            var cylinderGeo = new THREE.CylinderGeometry(15, 15, 40, 40, 40);
            var cylinderMat = new THREE.MeshLambertMaterial({ //创建材料
                color: 0xFF6600,
                wireframe: false
            });
            //创建圆柱体网格模型
            var cylinderMesh = new THREE.Mesh(cylinderGeo, cylinderMat);
            cylinderMesh.position.set(0, 20, -40); //设置圆柱坐标
            scene.add(cylinderMesh); //向场景添加圆柱体
        }

        //画线段
        function drawline(positions) {
            var geometry = new THREE.LineGeometry();
            geometry.setPositions( positions );
            // geometry.setColors( colors );
            var matLine = new THREE.LineMaterial( {
                color: "#222221",
                linewidth: 0.002,
                // vertexColors: THREE.VertexColors,
                dashed: false
            } );
            line = new THREE.Line2( geometry, matLine );
            line.computeLineDistances();
            line.scale.set( 1, 1, 1 );
            scene.add( line );
        }
        // 创建建筑
        function addMulGeometry(arrZ, arrX, height, mod) {
            // var arrX=[4,0,0,2.5,4];
            // var arrZ=[4,4,0,-2,0];
            // var height=4;
            var arrLength = arrX.length;
            var city = [];
            for (var i = 0; i < arrLength; i++) {
                city.push(new THREE.Vector2(arrZ[i],arrX[i]));
            }
            var depth = 0;
            if (mod == "3d"){
                depth = height;
            }
            var extrudeSettings = { depth: depth, bevelEnabled: false};
            var cityShape = new THREE.Shape(city);
            var points = cityShape.getPoints();

            var geometryPoints = new THREE.BufferGeometry().setFromPoints( points );
            // solid line
            var line = new THREE.Line( geometryPoints, new THREE.LineBasicMaterial( { color: 0x8DEEEE } ) );

            var particles = new THREE.Points( geometryPoints, new THREE.PointsMaterial( { color: '081469', size : 0.5 } ) );


            var geometry = new THREE.ExtrudeBufferGeometry( cityShape, extrudeSettings );
            var material = new THREE.MeshLambertMaterial({ //创建材料
                color: "#7e7d80",
                wireframe: false
            });
            var mesh = new THREE.Mesh( geometry,  material);
            mesh.rotation.x = -Math.PI / 2;
            mesh.rotation.z = -Math.PI / 2;
            mesh.name = "bd" + Math.random().toString(36).substr(2);
            builidings.push(mesh);

            line.rotation.x = -Math.PI / 2;
            line.rotation.z = -Math.PI / 2;

            particles.rotation.x = -Math.PI / 2;
            particles.rotation.z = -Math.PI / 2;
            mesh.layers.set(1);
            mesh.name = Math.random().toString(36).substr(2);
            scene.add(mesh);
            builidings.push(mesh);
            // scene.add(line);
            // scene.add(particles);
        }

        function addMulGeometryText() {
            var arrX = [67.18841944111367, 65.17594444951699, 56.737672119402966, 58.75014711099965];
            var arrZ = [157.04366246983577, 152.91279275128568, 155.91385194907826, 160.0447216678792];
            var height = 24;
            var arrLength = arrX.length;
            var geometry = new THREE.Geometry();
            for (var i = 0; i < arrLength; i++) {
                geometry.vertices.push(new THREE.Vector3(arrX[i], height, arrZ[i]));
            }
            for (var i = 0; i < arrLength; i++) {
                geometry.vertices.push(new THREE.Vector3(arrX[i], 0, arrZ[i]));
            }
            for (var i = 0; i < arrLength; i++) {
                if (i + arrLength + 1 == 2 * arrLength) {
                    geometry.faces.push(new THREE.Face3(i, (i + 1) % arrLength, arrLength));
                    geometry.faces.push(new THREE.Face3(i, arrLength, i + arrLength));
                } else {
                    geometry.faces.push(new THREE.Face3(i, (i + 1) % arrLength, i + arrLength + 1));
                    geometry.faces.push(new THREE.Face3(i, i + arrLength + 1, i + arrLength));
                }
            }
            for (var i = 0; i < arrLength - 2; i++) {
                geometry.faces.push(new THREE.Face3(0, i + 2, i + 1));
            }
            for (var i = 0; i < arrLength - 2; i++) {
                geometry.faces.push(new THREE.Face3(arrLength, arrLength + i + 1, arrLength + i + 2));
            }
            geometry.computeFaceNormals();
            var material = new THREE.MeshLambertMaterial({ //创建材料
                color: 0xffff00,
                wireframe: false
            });
            var mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
        }

        function addOwnGeometry() {
            var arrX = [0, 0, 4, 4];
            var arrY = [0, 4, 4, 0];
            var height = 4;
            var arrLength = arrX.length;
            // 创建一个立方体
            //    v6----- v5
            //   /|      /|
            //  v1------v0|
            //  | |     | |
            //  | |v7---|-|v4
            //  |/      |/
            //  v2------v3
            var geometry = new THREE.Geometry();
            //创建立方体的顶点
            //[x,y,z]
            //
            //        |y
            //        |
            //     (0,0,0)------x
            //       /
            //      /z
            var vertices = [
                new THREE.Vector3(10, 10, 10), //v0
                new THREE.Vector3(-10, 10, 10), //v1
                new THREE.Vector3(-10, -10, 10), //v2
                new THREE.Vector3(10, -10, 10), //v3
                new THREE.Vector3(10, -10, -10), //v4
                new THREE.Vector3(10, 10, -10), //v5
                new THREE.Vector3(-10, 10, -10), //v6
                new THREE.Vector3(-10, -10, -10) //v7
            ];

            geometry.vertices = vertices;
            //创建立方的面
            var faces = [
                new THREE.Face3(0, 1, 2),
                new THREE.Face3(0, 2, 3),
                new THREE.Face3(0, 3, 4),
                new THREE.Face3(0, 4, 5),
                new THREE.Face3(1, 6, 7),
                new THREE.Face3(1, 7, 2),
                new THREE.Face3(6, 5, 4),
                new THREE.Face3(6, 4, 7),
                new THREE.Face3(5, 6, 1),
                new THREE.Face3(5, 1, 0),
                new THREE.Face3(3, 2, 7),
                new THREE.Face3(3, 7, 4)
            ];

            geometry.faces = faces;
            //geometry.faces.push(new THREE.Face4(0, 1, 2, 3));
            // for(var i=0;i<arrLength;i++){
            //     geometry.vertices.push(new THREE.Vector3(arrX[i], arrY[i], height));
            // }
            // for(var i=0;i<arrLength;i++){
            //     geometry.vertices.push(new THREE.Vector3(arrX[i], arrY[i], 0));
            // }

            // for(var i=1;i<=arrLength-1;i++){
            //     geometry.faces.push(new THREE.Face3(0, i, (i+1)%arrLength));
            // }

            // for(var i=0;i<arrLength-1;i++){
            //     var temp=[i,(i+1)%arrLength,i+arrLength,(i+arrLength+1)]
            //     // temp[3]=temp[1]+arrLength
            //     geometry.faces.push(new THREE.Face3(temp[0], temp[1], temp[2]));
            //     geometry.faces.push(new THREE.Face3(temp[0], temp[1], temp[3]));
            //     geometry.faces.push(new THREE.Face3(temp[1], temp[2], temp[3]));

            // }
            // var temp=[0,arrLength-1,arrLength,arrLength*2-1]
            // geometry.faces.push(new THREE.Face3(temp[0], temp[1], temp[2]));
            // geometry.faces.push(new THREE.Face3(temp[0], temp[1], temp[3]));
            // geometry.faces.push(new THREE.Face3(temp[1], temp[2], temp[3]));

            // for(var i=1;i<=arrLength-2;i++){
            //     geometry.faces.push(new THREE.Face3(0+arrLength, i+arrLength, i+1+arrLength));
            // }
            // for(var i=0;i<=arrLength-2;i++){
            //     geometry.faces.push(new THREE.Face3(i, i+1, (i+2)%arrLength));
            // }
            // for(var i=0;i<=arrLength-2;i++){
            //     geometry.faces.push(new THREE.Face3(i+arrLength, i+1+arrLength, (i+2)%arrLength+arrLength));
            // }
            geometry.computeFaceNormals();
            var material = new THREE.MeshLambertMaterial({ //创建材料
                color: 0xffff00,
                wireframe: false
            });
            var mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
        }
        function addGeometry() {
            var geometry = new THREE.Geometry();
            // 设置顶点位置
            // 顶部4顶点
            geometry.vertices.push(new THREE.Vector3(-1, 2, -1));
            geometry.vertices.push(new THREE.Vector3(1, 2, -1));
            geometry.vertices.push(new THREE.Vector3(1, 2, 1));
            geometry.vertices.push(new THREE.Vector3(-1, 2, 1));
            // 底部4顶点
            geometry.vertices.push(new THREE.Vector3(-2, 0, -2));
            geometry.vertices.push(new THREE.Vector3(2, 0, -2));
            geometry.vertices.push(new THREE.Vector3(2, 0, 2));
            geometry.vertices.push(new THREE.Vector3(-2, 0, 2));

            // 设置顶点连接情况
            // 顶面
            geometry.faces.push(new THREE.Face3(0, 1, 3));
            geometry.faces.push(new THREE.Face3(1, 2, 3));
            //          geometry.faces.push(new THREE.Face4(0, 1, 2, 3));
            // 底面
            geometry.faces.push(new THREE.Face3(4, 5, 6));
            geometry.faces.push(new THREE.Face3(5, 6, 7));
            //          geometry.faces.push(new THREE.Face4(4, 5, 6, 7));
            // 侧面
            geometry.faces.push(new THREE.Face3(1, 5, 6));
            geometry.faces.push(new THREE.Face3(6, 2, 1));
            geometry.faces.push(new THREE.Face3(2, 6, 7));
            geometry.faces.push(new THREE.Face3(7, 3, 2));
            geometry.faces.push(new THREE.Face3(3, 7, 0));
            geometry.faces.push(new THREE.Face3(7, 4, 0));
            geometry.faces.push(new THREE.Face3(0, 4, 5));
            geometry.faces.push(new THREE.Face3(0, 5, 1));
            var material = new THREE.MeshLambertMaterial({ //创建材料
                color: 0xffff00,
                wireframe: false
            });
            var mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
        }


        //设置RX
        function onDocumentMouseDown2(event) {
            event.preventDefault();
            mouse.set((event.clientX / window.innerWidth) * 2 - 1, - (event.clientY / window.innerHeight) * 2 + 1);
            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObjects(objects);
            if (intersects.length > 0) {
                var intersect = intersects[0];
                loadFbx(intersect,"rx");
                // load3DS(intersect, "rx");
                scene.remove(rollOverMesh);
                var x = intersect.point.z;
                var y =  intersect.point.x;
                var longitude = x/80*(xmax - xmin) + (xmax + xmin) / 2;
                var latitude  = y/80*(xmax - xmin) + (ymax + ymin)  / 2;
                RxDTO = { "type": "rx", "longitude" : longitude , "latitude" : latitude};
                var str = JSON.stringify(RxDTO);
                sendMessage(str);
            }

            orbitControls.enabled = true;
            document.removeEventListener('mousemove', onDocumentMouseMove, false);
            document.removeEventListener('mousedown', onDocumentMouseDown2, false);

        }


        function onDocumentKeyDown(event) {
            switch (event.keyCode) {
                case 16: isShiftDown = true; break;
            }
        }
        function onDocumentKeyUp(event) {
            switch (event.keyCode) {
                case 16: isShiftDown = false; break;
            }
        }


        //渲染
        function render() {

            delta = clock.getDelta();
            orbitControls.update(delta);
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }

    </script>


    <!--read-file-->
    <script src="https://unpkg.com/shapefile@0.6"></script>

    <script>

        var fileInput = document.getElementById('file-input');
        var fileInput2 = document.getElementById('dbf-file-input');
        var roadfileInput = document.getElementById('road-file-input');
        var roadfileInput2 = document.getElementById('road-dbf-file-input');

        var shpBuffer;
        var dbfBuffer;

        var features = [];
        var senario = {};
        var roads = [];

        // 监听change事件:
        fileInput.addEventListener('change', function () {


            var file = fileInput.files[0];

            if (!(file.name.endsWith('.shp') )) {
                alert('Can only upload shp file.');
                return false;
            }
            // 读取文件:
            var reader = new FileReader();
            reader.onload = function(e) {
                  shpBuffer = e.target.result;

            };
            reader.readAsArrayBuffer(file);

        });

        roadfileInput.addEventListener('change', function () {


            var file = roadfileInput.files[0];

            if (!(file.name.endsWith('.shp') )) {
                alert('Can only upload shp file.');
                return false;
            }
            // 读取文件:
            var reader = new FileReader();
            reader.onload = function(e) {
                shpBuffer = e.target.result;

            };
            reader.readAsArrayBuffer(file);

        });

        fileInput2.addEventListener('change', function () {
            var file = fileInput2.files[0];


            if (!(file.name.endsWith('.dbf') )) {
                alert('Can only upload dbf file.');
                return false;
            }
            // 读取文件:
            var reader = new FileReader();
            reader.onload = function(e) {
                dbfBuffer = e.target.result;
            };
            reader.readAsArrayBuffer(file);

        });

        roadfileInput2.addEventListener('change', function () {
            var file = roadfileInput2.files[0];


            if (!(file.name.endsWith('.dbf') )) {
                alert('Can only upload dbf file.');
                return false;
            }
            // 读取文件:
            var reader = new FileReader();
            reader.onload = function(e) {
                dbfBuffer = e.target.result;
            };
            reader.readAsArrayBuffer(file);
        });

        function parseRoadFile() {

            shapefile.open(shpBuffer,dbfBuffer,{ encoding : "GB2312"})
                .then(source => source.read()
                    .then(function log(result) {
                        if (result.done) return;
                        // console.log(result)
                        var road = {
                            coordinates : result.value.geometry.coordinates,
                            name : result.value.properties.NAME
                        }
                        roads.push(road);
                        return source.read().then(log);
                    }).then(function () {
                        if (xmin == undefined){
                            xmin = source.bbox[0];
                            ymin = source.bbox[1];
                            xmax = source.bbox[2];
                            ymax = source.bbox[3];
                        }
                    }).then(function () {
                        drawRoad(roads);
                    }))
                .catch(error => console.error(error.stack));
        }
        function parseFile() {
            remove(builidings);
            var shp = "./file/BUILDING_nanjing.shp";
            var dbf = "./file/BUILDING_nanjing.dbf";
            if(shpBuffer != undefined && dbfBuffer != undefined){
                shp = shpBuffer;
                dbf = dbfBuffer;
            }
            shapefile.open(shp,dbf)
                .then(source => source.read()
                    .then(function log(result) {
                        if (result.done) return;
                        var feature = {
                            coordinates : result.value.geometry.coordinates[0],
                            z : result.value.properties.HEIGHT
                        }
                        features.push(feature);
                        return source.read().then(log);

                    }).then(function () {
                        senario = {
                            features : features,
                            bbox : source.bbox
                        }
                        // if (xmin == undefined){
                            xmin = source.bbox[0];
                            ymin = source.bbox[1];
                            xmax = source.bbox[2];
                            ymax = source.bbox[3];
                        // }

                    }).then(function () {
                        drawSenario(senario,"3d");
                    }).then(function () {
                        senario.type = "senario";
                        var str = JSON.stringify(senario);
                        sendMessage(str);
                    }))
                .catch(error => console.error(error.stack));
        }

        function parseDefaultfile(name){
            var building = "./" + name + "/BUILDING_nanjing.shp";
            var road = "./" + name + "/R.shp";
            var roaddbf = "./" + name + "/R.dbf";
            console.log(building);
            if(gui.domElement.children[1].childElementCount > 1){
                var nav = document.getElementById("gui");
                nav.removeChild(nav.firstElementChild);
                gui = new dat.GUI();
                var guiDomElement = gui.domElement;
                nav.appendChild(guiDomElement);

                gui.add( layers, 'plane' ).onChange( function () {
                    camera.layers.toggle( 0 );
                } );
                senario = {};
                features = [];
                roads = [];
                remove(builidings);
                remove(roadLines);
                remove(roadNames);
                remove(pathLines);
            }

            shapefile.open(building)
                .then(source => source.read()
                    .then(function log(result) {
                        if (result.done) return;
                        var feature = {
                            coordinates : result.value.geometry.coordinates[0],
                            z : result.value.properties.HEIGHT
                        }
                        features.push(feature);
                        return source.read().then(log);

                    }).then(function () {
                        senario = {
                            features : features,
                            bbox : source.bbox
                        }
                        // if (xmin == undefined){
                            xmin = source.bbox[0];
                            ymin = source.bbox[1];
                            xmax = source.bbox[2];
                            ymax = source.bbox[3];
                        // }

                    }).then(function () {
                        drawSenario(senario,"3d");
                    }).then(function () {
                        senario.type = "senario";
                        var str = JSON.stringify(senario);
                        sendMessage(str);
                    }))
                .catch(error => console.error(error.stack));

            shapefile.open(road,roaddbf,{ encoding : "GB2312"})
                .then(source => source.read()
                    .then(function log(result) {
                        if (result.done) return;

                        var road = {
                            coordinates : result.value.geometry.coordinates,
                            name : result.value.properties.NAME,
                            direction : result.value.properties.DIRECTION
                        }
                        // console.log(road.name);
                        // console.log(road.direction)
                        roads.push(road);
                        return source.read().then(log);
                    }).then(function () {
                        if (xmin == undefined){
                            xmin = source.bbox[0];
                            ymin = source.bbox[1];
                            xmax = source.bbox[2];
                            ymax = source.bbox[3];
                        }
                    }).then(function () {
                        drawRoad(roads);
                    }))
                .catch(error => console.error(error.stack));
        }


        var loader = new THREE.FontLoader();

        function drawFont(text,x,y,direction){
            loader.load( 'fonts/FZLanTingHeiS-UL-GB_Regular.json', function ( font ) {

                initFont( font,text,x,y,direction );

            } );
        }

        function initFont( font , text, x, y , direction) {

            // Get text from hash

            var theText = text;

            if (text == undefined){
                return
            }
            var hash = document.location.hash.substr( 1 );

            if ( hash.length !== 0 ) {

                theText = hash;

            }

            var geometry = new THREE.TextGeometry( theText, {
                font: font,
                size: 0.5,
                height: 0,
                weight: 'bold'
            });

            geometry.computeBoundingBox();

            var materials = [
                new THREE.MeshBasicMaterial( { color: 0x000000, overdraw: 0.5 } ),
                new THREE.MeshBasicMaterial( { color: 0x000000, overdraw: 0.5 } )
            ];

            var mesh = new THREE.Mesh( geometry, materials );

            mesh.position.x = y;
            mesh.position.y = 0.1;
            mesh.position.z = x;

            mesh.rotation.x = Math.PI / 2;
            mesh.rotation.y = Math.PI ;

            if (direction == "2"){
                mesh.rotation.z = Math.PI/2 ;
            }
            mesh.layers.set(2);
            mesh.name = Math.random().toString(36).substr(2);
            roadNames.push(mesh);
            scene.add( mesh );
        }



    </script>




</body>

</html>